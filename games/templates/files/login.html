
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadoo | Login or Register</title>

     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <meta name="author" content="Jadoo Sudoku">

     <meta name="description" content="Play beautiful, fast, and intuitive Sudoku online with Jadoo Sudoku. Enjoy daily challenges, track your stats, and relax your mind with our sleek, ad-free platform.">

     <meta name="keywords" content="Sudoku online, play Sudoku, free Sudoku games, daily Sudoku challenge, Jadoo Sudoku, Sudoku app, Sudoku game web, Sudoku for beginners, hard Sudoku, ad-free Sudoku, minimal Sudoku">

     <meta name="robots" content="index, follow">

     <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/Jadoo_Fav.png' %}">

     <meta property="og:type" content="website">
     <meta property="og:title" content="Jadoo Sudoku | Beautiful, Ad-Free Sudoku Online">
     <meta property="og:description" content="Challenge your brain with clean, intuitive Sudoku. Free daily puzzles. Zero distractions. Built for players who love to focus.">
     <meta property="og:image" content="{% static 'assets/Jadoo.png' %}">
     <meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}/">
     <meta property="og:site_name" content="Jadoo Sudoku">

     <meta name="twitter:card" content="summary_large_image">
     <meta name="twitter:title" content="Play Sudoku Online | Jadoo Sudoku">
     <meta name="twitter:description" content="Minimal design. Maximum focus. Free Sudoku puzzles that respect your time and space.">
     <meta name="twitter:image" content="{% static 'assets/Jadoo.png' %}">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f4f7f6; /* Very light grey for page background */
            --bg-card: #ffffff;
            --text-dark: #212529; /* Primary text color */
            --text-primary-accent: #000000; /* Black for main accents */
            --text-secondary: #495057; /* Slightly lighter dark grey */
            --text-muted-custom: #6c757d;
            --border-color-light: #dee2e6;
            --border-color-medium: #ced4da;
            --primary-accent: #000000; /* Black */
            --primary-accent-hover: #2a2a2a; /* Darker grey for hover */
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer shadow for light theme */
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-focus-border: #000000;
            --input-focus-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1); /* Lighter shadow for black focus */
            --btn-radius: 0.3rem;
            --card-radius: 0.5rem;
            --success-color: #198754; /* Bootstrap success green */
        }

        body {
            background-color: var(--bg-page);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
        }
        .auth-card {
            max-width: 460px;
            width: 100%;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            background-color: var(--bg-card);
            overflow: hidden;
        }
        .auth-card .card-header {
            background-color: var(--bg-card); /* White header */
            color: var(--text-primary-accent); /* Black text */
            text-align: center;
            padding: 30px 20px 20px; /* More top padding */
            border-bottom: 1px solid var(--border-color-light);
        }
        .auth-card .card-header h3 {
            font-size: 1.9rem; /* Slightly larger */
            font-weight: 700;
            margin-bottom: 0.35rem;
            letter-spacing: -0.5px;
        }
        .auth-card .card-header p {
            font-size: 0.95rem;
            color: var(--text-muted-custom);
            margin-bottom: 0;
        }
        .auth-card .card-body {
            padding: 30px 40px 40px; /* Adjusted padding */
        }
        .form-control {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: var(--btn-radius);
            padding: 0.8rem 1rem; /* Slightly more padding */
            font-size: 1rem;
            color: var(--text-dark);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-control::placeholder {
            color: #aaa; /* Lighter placeholder */
        }
        .form-control:focus {
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
            background-color: #fff;
        }
        .btn-primary-custom {
            background-color: var(--primary-accent);
            border-color: var(--primary-accent);
            color: #ffffff;
            padding: 0.8rem 1.5rem;
            border-radius: var(--btn-radius);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
        }
        .btn-primary-custom:hover {
            background-color: var(--primary-accent-hover);
            border-color: var(--primary-accent-hover);
            color: #ffffff;
            transform: translateY(-1px);
        }
        .btn-outline-primary-custom {
            color: var(--primary-accent);
            border: 2px solid var(--primary-accent); /* Slightly bolder outline */
            background-color: transparent;
            padding: 0.75rem 1.5rem; /* Adjusted padding to match primary */
            border-radius: var(--btn-radius);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        .btn-outline-primary-custom:hover {
            background-color: var(--primary-accent);
            color: #ffffff;
            transform: translateY(-1px);
        }
        .btn-link-custom {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        .btn-link-custom:hover {
            color: var(--primary-accent);
        }
        .form-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .alert {
            border-radius: var(--btn-radius);
            padding: 0.9rem 1.25rem;
            border: 1px solid transparent;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .alert-success {
            color: #0a3622;
            background-color: #d1e7dd;
            border-color: #a3cfbb;
        }
        .alert-danger {
            color: #58151c;
            background-color: #f8d7da;
            border-color: #f1b0b7;
        }
        .alert-info {
            color: #055160;
            background-color: #cff4fc;
            border-color: #9eeaf9;
        }
        .input-group .form-control {
            border-right: 1px solid var(--input-border);
        }
        .input-group .input-group-text {
            border: 1px solid var(--input-border);
            border-right: none;
            border-top-left-radius: var(--btn-radius) !important;
            border-bottom-left-radius: var(--btn-radius) !important;
            background-color: #f8f9fa;
            color: var(--text-muted-custom);
        }
        .modal-content {
            border-radius: var(--card-radius);
            border: none;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.15);
            background-color: var(--bg-card);
            color: var(--text-dark);
        }
        .modal-body {
            text-align: center;
            padding: 2.5rem;
        }
        #loadingModalIconContainer .spinner-border { /* Style spinner specifically */
            color: var(--primary-accent);
            width: 2.5rem;
            height: 2.5rem;
        }
        #loadingModalIconContainer .bi-check-circle-fill { /* Style success icon */
            font-size: 3rem;
            color: var(--success-color);
        }
        .form-section-title {
            font-weight: 600;
            color: var(--text-primary-accent);
            margin-bottom: 1.5rem;
        }
        .form-step-text {
            font-size: 0.9rem;
            color: var(--text-muted-custom);
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="card auth-card">
        <div class="card-header">
            <h3 class="mb-0">Jadoo</h3>
            <p class="mb-0">Sharpen Your Mind, Challenge Your Friends.</p>
        </div>
        <div class="card-body">
            <div id="authMessages" class="mb-3">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div id="authInitial">
                <div class="text-center mb-4">
                    <h5 class="form-section-title">Join Jadoo</h5>
                    <p class="form-step-text">Log in or create an account to start playing.</p>
                </div>
                <div class="d-grid gap-3">
                    <button class="btn btn-primary-custom" onclick="showLoginForm()">Log In</button>
                    <button class="btn btn-outline-primary-custom" onclick="showEmailVerificationForm()">Register</button>
                </div>
            </div>

            <div id="loginForm" style="display: none;">
                <h5 class="form-section-title text-center">Player Login</h5>
                <form id="loginFormElement" onsubmit="handleLogin(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="loginUsername" class="form-label">Username</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="loginUsername" name="username" placeholder="Your Username" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Password</label>
                        <div class="input-group">
                             <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                            <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Your Password" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100 mt-3">Log In</button>
                </form>
                <div class="text-center mt-4">
                    <button class="btn btn-link-custom" onclick="showAuthInitial()">
                        <i class="bi bi-arrow-left-short"></i> Back to Welcome
                    </button>
                </div>
            </div>

            <div id="emailVerificationFormDiv" style="display: none;">
                <h5 class="form-section-title text-center">Register - Step 1</h5>
                <p class="form-step-text text-center">Enter your email to receive a verification code.</p>
                <form id="emailVerificationFormElement" onsubmit="handleEmailVerification(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="emailAddress" class="form-label">Email Address</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            <input type="email" class="form-control" id="emailAddress" name="email" placeholder="you@example.com" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100">Send Code</button>
                </form>
                <div class="text-center mt-4">
                    <button class="btn btn-link-custom" onclick="showAuthInitial()">
                         <i class="bi bi-arrow-left-short"></i> Back to Welcome
                    </button>
                </div>
            </div>

            <div id="codeVerificationFormDiv" style="display: none;">
                <h5 class="form-section-title text-center">Verify Email</h5>
                 <p class="form-step-text text-center">A 6-digit code was sent to <strong id="displayVerifiedEmail" style="color: var(--text-primary-accent);">your email</strong>.</p>
                <form id="codeVerificationFormElement" onsubmit="handleCodeVerification(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="verificationCode" class="form-label">Verification Code</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-patch-check"></i></span>
                            <input type="text" class="form-control" id="verificationCode" name="code" placeholder="_ _ _ _ _ _" required pattern="\d{6}" title="Enter the 6-digit code" style="letter-spacing: 0.5em; text-align: center;">
                        </div>
                        <input type="hidden" id="hiddenEmailForCodeVerification" name="email">
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100">Verify Code</button>
                </form>
                <div class="text-center mt-4">
                    <button class="btn btn-link-custom" onclick="showEmailVerificationForm()">
                       <i class="bi bi-arrow-left-short"></i> Back to Email Entry
                    </button>
                </div>
            </div>

            <div id="signupFormDiv" style="display: none;">
                <h5 class="form-section-title text-center">Create Account</h5>
                <p class="form-step-text text-center">Almost there! Set up your username and password.</p>
                <form id="signupFormElement" onsubmit="handleSignup(event)">
                    {% csrf_token %}
                    <input type="hidden" id="signupEmail" name="email">
                    <div class="mb-3">
                        <label for="signupUsername" class="form-label">Username</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                            <input type="text" class="form-control" id="signupUsername" name="username" placeholder="Choose a Username" required minlength="3">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="signupPassword" class="form-label">Password</label>
                         <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key"></i></span>
                            <input type="password" class="form-control" id="signupPassword" name="password" placeholder="Min. 6 characters" required minlength="6">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                            <input type="password" class="form-control" id="signupConfirmPassword" name="confirm_password" placeholder="Re-enter Password" required minlength="6">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100 mt-3">Create Account</button>
                </form>
                <div class="text-center mt-4">
                     <button class="btn btn-link-custom" onclick="showCodeVerificationForm()">
                        <i class="bi bi-arrow-left-short"></i> Back to Code Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div id="loadingModalIconContainer" class="mb-3">
                        {__}
                    </div>
                    <h5 class="mb-0" id="loadingMessage" style="font-weight: 500; color: var(--text-dark);">Processing...</h5>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const nextUrl = "{{ next|escapejs }}" || "{% url 'home' %}";
        let verifiedEmailForSignup = "";
        let lastShownModalType = 'loading'; 

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // This function will be called after jQuery is confirmed to be loaded
        function initializeAuthScript() {
            // Ensure $ is jQuery
            const $ = window.jQuery;

            const csrftoken = getCookie('csrftoken') || $('input[name="csrfmiddlewaretoken"]').first().val();
            
            if (!csrftoken) {
                console.warn("CSRF Token not found. AJAX POST requests might fail. Ensure {% csrf_token %} is in your forms.");
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        if (csrftoken) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        } else {
                            // This console.error might fire if csrftoken is null from getCookie AND no form with the token is visible yet.
                            // It's a warning, the token might still be in a hidden form that jQuery can find later.
                            // console.error("CSRF token is missing at ajaxSetup. Request to", settings.url, "might be rejected.");
                        }
                    }
                }
            });
            showAuthInitial(); // Call your initial UI state function
        }

        // Check if jQuery is loaded. If yes, initialize. If not, wait for window.onload.
        if (window.jQuery) {
            // If jQuery is already loaded, use its ready function
            window.jQuery(document).ready(initializeAuthScript);
        } else {
            // If jQuery is not loaded yet, wait for the window to load completely
            // This is a fallback, ideally jQuery script tag is placed before this custom script
            console.error("jQuery is not loaded when script is parsed! Will try again on window.onload.");
            window.addEventListener('load', function() {
                if (window.jQuery) {
                    window.jQuery(document).ready(initializeAuthScript);
                } else {
                    // If jQuery still hasn't loaded, something is seriously wrong with its inclusion or CDN
                    console.error("jQuery still not loaded on window.onload! Authentication UI will not initialize correctly.");
                    const authMessagesDiv = document.getElementById('authMessages');
                    if (authMessagesDiv) {
                        authMessagesDiv.innerHTML = '<div class="alert alert-danger">Critical error: A required library (jQuery) did not load. Authentication may not work. Please check your connection or contact support.</div>';
                    }
                }
            });
        }


        // --- UI State Management Functions ---
        // Ensure these functions also check for jQuery before using $
        function hideAllSections() {
            if (!window.jQuery) return; 
            window.jQuery('#authInitial, #loginForm, #emailVerificationFormDiv, #codeVerificationFormDiv, #signupFormDiv').hide();
            window.jQuery('#authMessages').empty();
        }

        function showAuthInitial() { if (window.jQuery) { hideAllSections(); window.jQuery('#authInitial').fadeIn(300); } }
        function showLoginForm() { if (window.jQuery) { hideAllSections(); window.jQuery('#loginForm').fadeIn(300); } }
        function showEmailVerificationForm() { if (window.jQuery) { hideAllSections(); window.jQuery('#emailVerificationFormDiv').fadeIn(300); } }
        
        function showCodeVerificationForm(emailToVerify) {
            if (!window.jQuery) return;
            hideAllSections();
            if (emailToVerify) {
                 window.jQuery('#displayVerifiedEmail').text(emailToVerify);
                 window.jQuery('#hiddenEmailForCodeVerification').val(emailToVerify);
            } else if (verifiedEmailForSignup) {
                 window.jQuery('#displayVerifiedEmail').text(verifiedEmailForSignup);
                 window.jQuery('#hiddenEmailForCodeVerification').val(verifiedEmailForSignup);
            } else {
                window.jQuery('#displayVerifiedEmail').text("your email");
            }
            window.jQuery('#codeVerificationFormDiv').fadeIn(300);
        }
        function showSignupForm(emailFromVerification) {
            if (!window.jQuery) return;
            hideAllSections();
            if (emailFromVerification) window.jQuery('#signupEmail').val(emailFromVerification);
            window.jQuery('#signupFormDiv').fadeIn(300);
        }

        function showAuthMessage(message, type = 'success') {
            if (!window.jQuery) return;
            const alertClass = type === 'success' ? 'alert-success' : (type === 'error' ? 'alert-danger' : 'alert-info');
            window.jQuery('#authMessages').html(
                `<div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="font-weight: 500;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`
            ).hide().fadeIn(300);
        }

        // --- Modal Functions ---
        let loadingModalInstance;
        function showLoadingModal(message, type = 'loading') {
            if (!window.bootstrap || !window.jQuery) { 
                console.error("Modal dependencies (jQuery/Bootstrap) not loaded. Cannot show modal.");
                // Optionally show a basic alert if modals can't be used
                // alert(message); 
                return;
            }
            lastShownModalType = type;
            const modalEl = document.getElementById('loadingModal');
            const iconContainer = document.getElementById('loadingModalIconContainer');
            const messageEl = document.getElementById('loadingMessage');

            messageEl.textContent = message;

            if (type === 'success') {
                iconContainer.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            } else {
                iconContainer.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
            }
            
            if (!loadingModalInstance) {
                loadingModalInstance = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
            }
            try {
                loadingModalInstance.show();
            } catch (e) {
                console.error("Error showing modal:", e);
            }
        }
        
        function hideLoadingModal() {
            if (!window.bootstrap || !window.jQuery) return;
            if (loadingModalInstance) {
                const delay = lastShownModalType === 'success' ? 500 : 50;
                setTimeout(() => {
                    if (loadingModalInstance) {
                        try {
                            loadingModalInstance.hide();
                        } catch (e) {
                            console.error("Error hiding modal in timeout:", e);
                        }
                    }
                }, delay);
            }
        }
        
        function hideLoadingModalImmediately() {
            if (!window.bootstrap || !window.jQuery) return;
            if (loadingModalInstance) {
                try {
                    loadingModalInstance.hide();
                    // Force remove backdrop if it lingers (Bootstrap 5 might handle this better)
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';


                } catch (e) {
                    console.error("Error hiding modal immediately:", e);
                }
            }
        }

        // --- Form Handlers ---
        function handleLogin(event) {
            event.preventDefault();
            if (!window.jQuery) { showAuthMessage("Page not fully loaded. Please wait.", "error"); return; }
            showLoadingModal("Authenticating...", 'loading');
            const formData = new FormData(document.getElementById('loginFormElement'));
            
            window.jQuery.ajax({ // Use window.jQuery explicitly
                url: "{% url 'login_page' %}",
                type: "POST", data: formData, processData: false, contentType: false,
                success: function(response) {
                    if (response.status === true) {
                        showLoadingModal(response.message + " Redirecting...", 'success');
                        setTimeout(() => {
                            window.location.href = response.redirect_url || nextUrl;
                        }, 1500);
                    } else {
                        hideLoadingModalImmediately();
                        showAuthMessage(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    hideLoadingModalImmediately();
                    console.error("Login AJAX Error:", xhr.status, xhr.statusText, xhr.responseText);
                    const errorMsg = xhr.responseJSON?.error || "Login failed. Please try again.";
                    showAuthMessage(errorMsg, 'error');
                }
            });
        }

        function handleEmailVerification(event) {
            event.preventDefault();
            if (!window.jQuery) { showAuthMessage("Page not fully loaded. Please wait.", "error"); return; }
            showLoadingModal("Sending Code...", 'loading');
            const formData = new FormData(document.getElementById('emailVerificationFormElement'));
            const email = formData.get('email');
            
            window.jQuery.ajax({ // Use window.jQuery explicitly
                url: "{% url 'send_verification_code' %}",
                type: "POST", data: formData, processData: false, contentType: false,
                success: function(response) {
                    hideLoadingModal();
                    if (response.status === true) {
                        showAuthMessage(response.message, 'success');
                        verifiedEmailForSignup = email;
                        showCodeVerificationForm(email);
                    } else { 
                        showAuthMessage(response.error, 'error'); 
                    }
                },
                error: function(xhr) {
                    hideLoadingModalImmediately();
                    console.error("Email Verification AJAX Error:", xhr.status, xhr.statusText, xhr.responseText);
                    const errorMsg = xhr.responseJSON?.error || "Failed to send code. Please try again.";
                    showAuthMessage(errorMsg, 'error');
                }
            });
        }

        function handleCodeVerification(event) {
            event.preventDefault();
            if (!window.jQuery) { showAuthMessage("Page not fully loaded. Please wait.", "error"); return; }
            console.log("handleCodeVerification: Initiated.");
            showLoadingModal("Verifying Code...", 'loading');
            const formData = new FormData(document.getElementById('codeVerificationFormElement'));
            if (verifiedEmailForSignup && !formData.has('email_for_verification')) {
                formData.append('email_for_verification', verifiedEmailForSignup);
            } else if (!formData.has('email_for_verification')) {
                 const displayedEmail = window.jQuery('#displayVerifiedEmail').text();
                 if (displayedEmail && displayedEmail !== "your email") {
                    formData.append('email_for_verification', displayedEmail);
                 }
            }
            console.log("handleCodeVerification: Sending AJAX. FormData email:", formData.get('email_for_verification'));
            
            window.jQuery.ajax({ // Use window.jQuery explicitly
                url: "{% url 'verify_email_code' %}",
                type: "POST", data: formData, processData: false, contentType: false,
                success: function(response) {
                    console.log("handleCodeVerification: AJAX Success. Raw Response:", response);
                    hideLoadingModalImmediately();
                    if (response && response.status === true) {
                        console.log("handleCodeVerification: Verification success on client. Message:", response.message);
                        showAuthMessage(response.message, 'success');
                        showSignupForm(verifiedEmailForSignup);
                    } else {
                        const serverErrorMsg = response && response.error ? response.error : "Verification failed: Unexpected server response.";
                        console.log("handleCodeVerification: Verification failed on server. Error:", serverErrorMsg);
                        showAuthMessage(serverErrorMsg, 'error');
                        showCodeVerificationForm(verifiedEmailForSignup); 
                    }
                },
                error: function(xhr, status, error) {
                    console.error("handleCodeVerification: AJAX Error. Status:", status, "Error:", error, "Response Text:", xhr.responseText);
                    hideLoadingModalImmediately();
                    let errorMsg = "Code verification request failed. Please check your connection and try again.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (xhr.status === 403) {
                        errorMsg = "Verification failed (403 Forbidden). This might be a CSRF issue. Please refresh the page and try again.";
                    } else if (xhr.responseText && xhr.responseText.toLowerCase().includes("csrf")) {
                        errorMsg = "Verification failed (CSRF related). Please refresh and try again.";
                    }
                    showAuthMessage(errorMsg, 'error');
                    showCodeVerificationForm(verifiedEmailForSignup); 
                }
            });
        }

        function handleSignup(event) {
            event.preventDefault();
            if (!window.jQuery) { showAuthMessage("Page not fully loaded. Please wait.", "error"); return; }
            showLoadingModal("Creating Account...", 'loading');
            const formData = new FormData(document.getElementById('signupFormElement'));
            formData.set('email', window.jQuery('#signupEmail').val());

            window.jQuery.ajax({ // Use window.jQuery explicitly
                url: "{% url 'signup_submit' %}",
                type: "POST", data: formData, processData: false, contentType: false,
                success: function(response) {
                    if (response.status === true) {
                        showLoadingModal(response.message + " Redirecting...", 'success');
                        setTimeout(() => {
                            window.location.href = response.redirect_url || nextUrl;
                        }, 1500);
                    } else {
                        hideLoadingModalImmediately();
                        showAuthMessage(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    hideLoadingModalImmediately();
                    console.error("Signup AJAX Error:", xhr.status, xhr.statusText, xhr.responseText);
                    const errorMsg = xhr.responseJSON?.error || "Signup failed. Please try again.";
                    showAuthMessage(errorMsg, 'error');
                }
            });
        }
    </script>
</body>
</html>
