{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadoo | Login & SignUp</title>
    <meta name="description" content="Jadoo helps students study smarter by turning their notes and past papers into flashcards and predicted exam questions. Get started free — only $1.50/month for unlimited uploads.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Author -->
    <meta name="author" content="Jadoo Team">

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/Jadoo_Fav.png' %}">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Jadoo Study — AI-Powered Exam Prep Made Simple">
    <meta property="og:description" content="Turn notes into quizzes and flashcards instantly. Study one topic for free every day. Just $1.50/month for full access.">
    <meta property="og:image" content="{% static 'assets/img/Jadoo.png' %}">
    <meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}/">
    <meta property="og:site_name" content="Jadoo Study">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Jadoo Study — Smart Revision for Students">
    <meta name="twitter:description" content="Upload your notes. Get instant flashcards and predicted questions. One free topic per day. Just $1.50/month for more.">
    <meta name="twitter:image" content="{% static 'assets/img/Jadoo.png' %}">

    <!-- SEO Keywords -->
    <meta name="keywords" content="jadoo study, ai study tool, flashcards generator, ai exam prep, past paper analyzer, affordable student tool, jadoo education, free revision tool, summarize notes ai, quiz generator, Kenyan student revision, digital tutor, student ai assistant, ai tutor for exams">

    <!-- Robots & Accessibility -->
    <meta name="robots" content="index, follow">
    <meta name="language" content="en">
    <meta name="application-name" content="Jadoo Study">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="generator" content="Jadoo Studio MVP">

    <!-- Schema Markup for SEO and AI Tools -->
    <script type="application/ld+json">
    {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Jadoo Study",
    "url": "{{ request.scheme }}://{{ request.get_host }}/",
    "author": {
        "@type": "Organization",
        "name": "Jadoo"
    },
    "description": "Jadoo is an AI-powered study tool that turns student notes and sample exams into flashcards and predicted exam questions. Study one topic per day for free or subscribe for full access at just $1.50/month.",
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "All",
    "inLanguage": "en"
    }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            max-width: 450px;
            width: 100%;
            border-radius: 15px;
            background: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .auth-card .card-header {
            background-color: #000000;
            color: #ffffff;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            text-align: center;
            padding: 20px;
        }
        .auth-card .card-body {
            padding: 30px;
        }
        .btn-primary {
            background-color: #000000;
            border-color: #000000;
        }
        .btn-primary:hover {
            background-color: #333333;
            border-color: #333333;
        }
        .btn-outline-primary {
            color: #000000;
            border-color: #000000;
        }
        .btn-outline-primary:hover {
            background-color: #000000;
            color: #ffffff;
        }
        .form-label {
            font-weight: 500;
            color: #000000;
        }
        .text-primary {
            color: #000000 !important;
        }
        .alert {
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .form-control {
            border-color: #000000;
        }
        .form-control:focus {
            border-color: #333333;
            box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
        }
        .btn-link {
            color: #000000;
        }
        .btn-link:hover {
            color: #333333;
        }
        .btn-logout {
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }
        .btn-logout:hover {
            background-color: #000000;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="card auth-card">
        <div class="card-header">
            <h3 class="mb-0">Authentication</h3>
            <p class="mb-0">Secure Access to Your Account</p>
        </div>
        <div class="card-body">
            <!-- Messages -->
            <div id="authMessages" class="mb-3"></div>

            <!-- Initial State: Login or Register -->
            <div id="authInitial">
                <div class="text-center mb-4">
                    <h5>Welcome</h5>
                    <p>Please log in or register to continue.</p>
                </div>
                <div class="d-flex justify-content-around">
                    <button class="btn btn-outline-primary rounded-pill px-4" onclick="showLoginForm()">Log In</button>
                    <button class="btn btn-primary rounded-pill px-4" onclick="showEmailVerification()">Register</button>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" style="display: none;">
                <h5 class="mb-3">Log In</h5>
                <form id="loginFormElement" onsubmit="handleLogin(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="loginUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="loginUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Log In</button>
                </form>
                <div class="text-center mt-3">
                    <button class="btn btn-link text-primary" onclick="showAuthInitial()">Back</button>
                </div>
            </div>

            <!-- Email Verification: Step 1 (Enter Email) -->
            <div id="emailVerification" style="display: none;">
                <h5 class="mb-3">Verify Your Email</h5>
                <form id="emailVerificationForm" onsubmit="handleEmailVerification(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="emailAddress" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="emailAddress" name="email" placeholder="example@domain.com" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Send Verification Code</button>
                </form>
                <div class="text-center mt-3">
                    <button class="btn btn-link text-primary" onclick="showAuthInitial()">Back</button>
                </div>
            </div>

            <!-- Email Verification: Step 2 (Enter Code) -->
            <div id="codeVerification" style="display: none;">
                <h5 class="mb-3">Enter Verification Code</h5>
                <form id="codeVerificationForm" onsubmit="handleCodeVerification(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="verificationCode" class="form-label">Code</label>
                        <input type="text" class="form-control" id="verificationCode" name="code" required>
                        <input type="hidden" id="verifiedEmailAddress" name="email">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Verify Code</button>
                </form>
                <div class="text-center mt-3">
                    <button class="btn btn-link text-primary" onclick="showEmailVerification()">Resend Code</button>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <h5 class="mb-3">Sign Up</h5>
                <form id="signupFormElement" onsubmit="handleSignup(event)">
                    {% csrf_token %}
                    <input type="hidden" id="signupEmail" name="email">
                    <div class="mb-3">
                        <label for="signupUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="signupUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="signupConfirmPassword" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Sign Up</button>
                </form>
                <div class="text-center mt-3">
                    <button class="btn btn-link text-primary" onclick="showCodeVerification()">Back</button>
                </div>
            </div>

            <!-- Success State: Logged In -->
            <div id="successState" style="display: none;">
                <div class="text-center mb-4">
                    <h5>Welcome Back!</h5>
                    <p>You are now logged in.</p>
                </div>
                <div class="d-flex justify-content-around">
                    <button class="btn btn-primary rounded-pill px-4" onclick="handleGoHome()">Go to Home</button>
                    <button class="btn btn-logout rounded-pill px-4" onclick="handleLogout()">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redirection Modal -->
    <div class="modal fade" id="redirectionModal" tabindex="-1" aria-labelledby="redirectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mt-3" id="redirectionMessage"></h5>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State management
        function showAuthInitial() {
            hideAllSections();
            $('#authInitial').show();
        }

        function showLoginForm() {
            hideAllSections();
            $('#loginForm').show();
        }

        function showEmailVerification() {
            hideAllSections();
            $('#emailVerification').show();
        }

        function showCodeVerification() {
            hideAllSections();
            $('#codeVerification').show();
        }

        function showSignupForm() {
            hideAllSections();
            $('#signupForm').show();
        }

        function showSuccessState() {
            hideAllSections();
            $('#successState').show();
        }

        function hideAllSections() {
            $('#authInitial').hide();
            $('#loginForm').hide();
            $('#emailVerification').hide();
            $('#codeVerification').hide();
            $('#signupForm').hide();
            $('#successState').hide();
            $('#authMessages').empty();
        }

        function showMessage(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            $('#authMessages').html(`<div class="alert ${alertClass}">${message}</div>`);
        }

        // Modal control functions
        function showRedirectionModal(message) {
            $('#redirectionMessage').text(message);
            const modal = new bootstrap.Modal(document.getElementById('redirectionModal'), {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
            setTimeout(() => {
                const modalElement = document.getElementById('redirectionModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                    modalInstance.dispose();
                }
            }, 10000);
        }

        function hideRedirectionModal() {
            const modalElement = document.getElementById('redirectionModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.hide();
            modalElement.addEventListener('hidden.bs.modal', function handler() {
                modal.dispose();
                modalElement.removeEventListener('hidden.bs.modal', handler);
            }, { once: true });
        }

        // CSRF token setup
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = cookie.substring('csrftoken='.length, cookie.length);
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize CSRF token by making a GET request to the login page
        $(document).ready(function() {
            $.ajax({
                url: '/',
                type: 'GET',
                success: function(response) {
                    // CSRF cookie should be set by Django on this GET request
                    console.log('CSRF cookie initialized');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to initialize CSRF cookie:', status, error);
                    showMessage('Failed to initialize session. Please refresh the page.', 'error');
                }
            });

            // Set up CSRF token for all AJAX POST requests
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        const csrfToken = getCSRFToken();
                        if (csrfToken) {
                            xhr.setRequestHeader('X-CSRFToken', csrfToken);
                        } else {
                            console.error('CSRF token not found');
                            showMessage('Session error: CSRF token not found. Please refresh the page.', 'error');
                            return false; // Cancel the request if no CSRF token
                        }
                    }
                }
            });
        });

        // Form handlers
        function handleLogin(event) {
            event.preventDefault();
            showRedirectionModal("Logging in...");
            const formData = new FormData(document.getElementById('loginFormElement'));

            $.ajax({
                url: '/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    hideRedirectionModal();
                    if (response.status) {
                        showMessage(response.message);
                        showSuccessState();
                    } else {
                        showMessage(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    hideRedirectionModal();
                    if (xhr.status === 403) {
                        showMessage('Session error: Please refresh the page and try again.', 'error');
                    } else {
                        showMessage('An error occurred. Please try again.', 'error');
                    }
                }
            });
        }

        function handleEmailVerification(event) {
            event.preventDefault();
            showRedirectionModal("Sending verification code...");
            const formData = new FormData(document.getElementById('emailVerificationForm'));
            const email = formData.get('email');

            $.ajax({
                url: '/send-verification-code/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    hideRedirectionModal();
                    if (response.status) {
                        showMessage(response.message);
                        $('#verifiedEmailAddress').val(email);
                        $('#signupEmail').val(email);
                        showCodeVerification();
                    } else {
                        showMessage(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    hideRedirectionModal();
                    if (xhr.status === 403) {
                        showMessage('Session error: Please refresh the page and try again.', 'error');
                    } else {
                        showMessage('An error occurred. Please try again.', 'error');
                    }
                }
            });
        }

        function handleCodeVerification(event) {
            event.preventDefault();
            showRedirectionModal("Verifying code...");
            const formData = new FormData(document.getElementById('codeVerificationForm'));

            $.ajax({
                url: '/verify-email-code/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    hideRedirectionModal();
                    if (response.status) {
                        showMessage(response.message);
                        showSignupForm();
                    } else {
                        showMessage(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    hideRedirectionModal();
                    if (xhr.status === 403) {
                        showMessage('Session error: Please refresh the page and try again.', 'error');
                    } else {
                        showMessage('An error occurred. Please try again.', 'error');
                    }
                }
            });
        }

        function handleSignup(event) {
            event.preventDefault();
            showRedirectionModal("Signing up...");
            const formData = new FormData(document.getElementById('signupFormElement'));

            $.ajax({
                url: '/signup/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    hideRedirectionModal();
                    if (response.status) {
                        showMessage(response.message);
                        showSuccessState();
                    } else {
                        showMessage(response.error, 'error');
                    }
                },
                error: function(xhr) {
                    hideRedirectionModal();
                    if (xhr.status === 403) {
                        showMessage('Session error: Please refresh the page and try again.', 'error');
                    } else {
                        showMessage('An error occurred. Please try again.', 'error');
                    }
                }
            });
        }

        function handleGoHome() {
            showRedirectionModal("Redirecting to home...");
            setTimeout(() => {
                window.location.href = '/index/';
            }, 1000);
        }

        function handleLogout() {
            showRedirectionModal("Logging out...");
            $.ajax({
                url: '/logout/',
                type: 'POST',
                success: function() {
                    hideRedirectionModal();
                    showMessage("Logged out successfully.", 'success');
                    showAuthInitial();
                },
                error: function(xhr) {
                    hideRedirectionModal();
                    if (xhr.status === 403) {
                        showMessage('Session error: Please refresh the page and try again.', 'error');
                    } else {
                        showMessage('An error occurred. Please try again.', 'error');
                    }
                }
            });
        }

        // Initialize by showing initial state
        showAuthInitial();
    </script>
</body>
</html>